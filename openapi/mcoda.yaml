openapi: 3.1.0
info:
  title: mcoda API
  version: 0.0.0
tags:
  - name: Agents
    description: Global agent registry and credentials
  - name: Routing
    description: Workspace routing defaults and previews
  - name: Tasks
    description: Task detail, comments, dependency ordering
  - name: Work
    description: Planning and execution flows
  - name: Review
    description: Code review workflows
  - name: QA
    description: QA orchestration and verification
  - name: Backlog
    description: Backlog visibility and ordering
  - name: Estimate
    description: Estimation and velocity reporting
  - name: Telemetry
    description: Token usage and aggregated telemetry
  - name: Jobs
    description: Job engine and command runs
  - name: Docdex
    description: Documentation retrieval and indexing
  - name: Config
    description: Workspace configuration
  - name: System
    description: System health and metadata
paths:
  /agents:
    get:
      summary: List configured agents
      operationId: listAgents
      tags: [Agents]
      responses:
        "200":
          description: Agents list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"
      x-mcoda-cli.name: agent
      x-mcoda-cli.output-shape: table
      x-mcoda-tools:
        - docdex
      x-mcoda-docdex-profile: sds
    post:
      summary: Create a new agent
      operationId: createAgent
      tags: [Agents]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Agent"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
      x-mcoda-cli.name: agent
      x-mcoda-cli.output-shape: scalar
      x-mcoda-prompts:
        - agent_manage
  /agents/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Agent id or slug
    get:
      summary: Get an agent
      operationId: getAgent
      tags: [Agents]
      responses:
        "200":
          description: Agent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
      x-mcoda-cli.name: agent
      x-mcoda-cli.output-shape: scalar
    put:
      summary: Update an agent
      operationId: updateAgent
      tags: [Agents]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Agent"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
      x-mcoda-cli.name: agent
      x-mcoda-cli.output-shape: scalar
    delete:
      summary: Delete an agent
      operationId: deleteAgent
      tags: [Agents]
      responses:
        "204":
          description: Deleted
      x-mcoda-cli.name: agent
      x-mcoda-cli.output-shape: scalar
  /agents/{id}/test:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      summary: Test an agent connection
      operationId: testAgent
      tags: [Agents]
      responses:
        "200":
          description: Health result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  latencyMs:
                    type: number
                  lastCheckedAt:
                    type: string
                    format: date-time
      x-mcoda-cli.name: test-agent
      x-mcoda-cli.output-shape: scalar
      x-mcoda-agent-roles:
        - reviewer
  /workspaces/{id}/defaults:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Get routing defaults for a workspace
      operationId: getRoutingDefaults
      tags: [Routing]
      responses:
        "200":
          description: Routing defaults
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoutingDefaults"
      x-mcoda-cli.name: routing
      x-mcoda-cli.output-shape: scalar
      x-mcoda-docdex-profile: sds
    put:
      summary: Update routing defaults for a workspace
      operationId: updateRoutingDefaults
      tags: [Routing]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoutingDefaults"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoutingDefaults"
      x-mcoda-cli.name: routing
      x-mcoda-cli.output-shape: scalar
      x-mcoda-prompts:
        - routing_defaults
  /routing/preview:
    post:
      summary: Preview routing for a command
      operationId: routingPreview
      tags: [Routing]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                workspaceId:
                  type: string
                commandName:
                  type: string
                agentOverride:
                  type: string
      responses:
        "200":
          description: Preview
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RoutingPreview"
      x-mcoda-cli.name: routing
      x-mcoda-cli.output-shape: scalar
      x-mcoda-docdex-profile: sds
  /tasks/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Get task detail
      operationId: getTask
      tags: [Tasks]
      responses:
        "200":
          description: Task
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
      x-mcoda-cli.name: task-detail
      x-mcoda-cli.output-shape: scalar
      x-mcoda-db-table: tasks
  /tasks/{id}/comments:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: List task comments
      operationId: listTaskComments
      tags: [Tasks]
      responses:
        "200":
          description: Comments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TaskComment"
      x-mcoda-cli.name: task-detail
      x-mcoda-cli.output-shape: table
    post:
      summary: Add a task comment
      operationId: createTaskComment
      tags: [Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskComment"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskComment"
      x-mcoda-cli.name: task-detail
      x-mcoda-cli.output-shape: scalar
      x-mcoda-db-table: task_comments
  /tasks/{id}/reviews:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: List task reviews
      operationId: listTaskReviews
      tags: [Tasks]
      responses:
        "200":
          description: Reviews
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TaskReview"
      x-mcoda-cli.output-shape: table
      x-mcoda-db-table: task_reviews
    post:
      summary: Add a task review decision
      operationId: createTaskReview
      tags: [Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskReview"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskReview"
      x-mcoda-cli.output-shape: scalar
      x-mcoda-db-table: task_reviews
  /workspaces/{id}/backlog:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - name: project
        in: query
        schema:
          type: string
      - name: epic
        in: query
        schema:
          type: string
      - name: story
        in: query
        schema:
          type: string
      - name: assignee
        in: query
        schema:
          type: string
      - name: status
        in: query
        schema:
          type: string
    get:
      summary: Backlog view for a workspace
      operationId: backlog
      tags: [Backlog, Tasks]
      responses:
        "200":
          description: Backlog summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BacklogSummary"
      x-mcoda-cli.name: backlog
      x-mcoda-cli.output-shape: table
      x-mcoda-db-table: tasks
  /workspaces/{id}/estimate:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - name: project
        in: query
        schema:
          type: string
      - name: epic
        in: query
        schema:
          type: string
      - name: story
        in: query
        schema:
          type: string
      - name: assignee
        in: query
        schema:
          type: string
      - name: spPerHour
        in: query
        schema:
          type: number
      - name: spPerHourReview
        in: query
        schema:
          type: number
      - name: spPerHourQa
        in: query
        schema:
          type: number
      - name: velocityMode
        in: query
        schema:
          type: string
          enum: [config, empirical, mixed]
      - name: velocityWindow
        in: query
        schema:
          type: number
          enum: [10, 20, 50]
    get:
      summary: Estimate backlog durations and ETAs
      operationId: estimate
      tags: [Estimate, Telemetry]
      responses:
        "200":
          description: Estimate summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EstimateResult"
      x-mcoda-cli.name: estimate
      x-mcoda-cli.output-shape: scalar
      x-mcoda-docdex-profile: workspace-code
  /workspaces/{id}/create-tasks:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      summary: Create tasks from requirements
      operationId: createTasks
      tags: [Work, Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                epicId:
                  type: string
                storyId:
                  type: string
                instructions:
                  type: string
      responses:
        "202":
          description: Job created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
      x-mcoda-cli.name: create-tasks
      x-mcoda-cli.output-shape: job
      x-mcoda-job-type: create_tasks
      x-mcoda-agent-roles:
        - planner
      x-mcoda-prompts:
        - create_tasks
      x-mcoda-tools:
        - docdex
        - vcs
      x-mcoda-docdex-profile: sds
  /tasks/refine:
    post:
      summary: Refine existing tasks in a workspace project
      operationId: refineTasks
      tags: [Work, Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefineTasksRequest"
      responses:
        "200":
          description: Planned or executed refinement
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefineTasksResult"
      x-mcoda-cli.name: refine-tasks
      x-mcoda-cli.output-shape: job
      x-mcoda-job-type: task_refinement
      x-mcoda-agent-roles:
        - planner
      x-mcoda-prompts:
        - refine_tasks
      x-mcoda-tools:
        - docdex
      x-mcoda-docdex-profile: sds
  /workspaces/{id}/work-on-tasks:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      summary: Execute work on selected tasks
      operationId: workOnTasks
      tags: [Work, Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkOnTasksRequest"
      responses:
        "200":
          description: Work execution summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkOnTasksResult"
      x-mcoda-cli.name: work-on-tasks
      x-mcoda-cli.output-shape: work_on_tasks_result
      x-mcoda-job-type: work
      x-mcoda-agent-roles:
        - worker
      x-mcoda-prompts:
        - work_on_tasks
      x-mcoda-tools:
        - vcs
        - docdex
      x-mcoda-docdex-profile: workspace-code
  /workspaces/{id}/code-review:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      summary: Run code review on tasks
      operationId: codeReview
      tags: [Review, Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                taskIds:
                  type: array
                  items:
                    type: string
                baseRef:
                  type: string
      responses:
        "202":
          description: Job created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
      x-mcoda-cli.name: code-review
      x-mcoda-cli.output-shape: job
      x-mcoda-job-type: review
      x-mcoda-agent-roles:
        - reviewer
      x-mcoda-prompts:
        - code_review
      x-mcoda-tools:
        - vcs
        - docdex
      x-mcoda-docdex-profile: workspace-code
  /workspaces/{id}/qa-tasks:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      summary: Run QA on tasks
      operationId: qaTasks
      tags: [QA, Tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                projectKey:
                  type: string
                  description: Key of the project to scope QA runs.
                epicKey:
                  type: string
                  description: Optional epic key filter.
                storyKey:
                  type: string
                  description: Optional user story key filter.
                taskKeys:
                  type: array
                  description: Explicit list of task keys to QA.
                  items:
                    type: string
                statusFilter:
                  type: array
                  description: Status filter, defaults to ready_to_qa.
                  items:
                    type: string
                mode:
                  type: string
                  enum: [auto, manual]
                  default: auto
                profile:
                  type: string
                  description: Explicit QA profile name to use.
                level:
                  type: string
                  description: Level hint (unit|integration|acceptance) for profile selection.
                testCommand:
                  type: string
                  description: Override CLI test command when runner=cli.
                agent:
                  type: string
                  description: QA agent to interpret results.
                agentStream:
                  type: boolean
                  default: true
                createFollowupTasks:
                  type: string
                  enum: [auto, none, prompt]
                  default: auto
                dryRun:
                  type: boolean
                  default: false
                result:
                  type: string
                  enum: [pass, fail, blocked]
                  description: Manual result when mode=manual.
                notes:
                  type: string
                  description: Optional manual QA notes.
                evidenceUrl:
                  type: string
                  description: Optional manual QA evidence URL.
      responses:
        "202":
          description: Job created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
      x-mcoda-cli.name: qa-tasks
      x-mcoda-cli.output-shape: job
      x-mcoda-job-type: qa
      x-mcoda-agent-roles:
        - qa
      x-mcoda-prompts:
        - qa_tasks
      x-mcoda-tools:
        - qa_runner
        - vcs
      x-mcoda-docdex-profile: workspace-code
  /workspaces/{id}/order-tasks:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - name: strategy
        in: query
        schema:
          type: string
          enum: [dependencies, priority]
    get:
      summary: Order tasks by dependency/priority
      operationId: orderTasks
      tags: [Tasks, Backlog]
      responses:
        "200":
          description: Ordered tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TaskSummary"
      x-mcoda-cli.name: order-tasks
      x-mcoda-cli.output-shape: list
      x-mcoda-prompts:
        - order_tasks
  /jobs:
    get:
      summary: List jobs
      operationId: listJobs
      tags: [Jobs]
      responses:
        "200":
          description: Jobs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Job"
      x-mcoda-cli.name: job
      x-mcoda-cli.output-shape: table
      x-mcoda-db-table: jobs
  /jobs/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Get a job
      operationId: getJob
      tags: [Jobs]
      responses:
        "200":
          description: Job
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
      x-mcoda-cli.name: job
      x-mcoda-cli.output-shape: scalar
      x-mcoda-db-table: jobs
  /jobs/{id}/resume:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      summary: Resume a job
      operationId: resumeJob
      tags: [Jobs]
      responses:
        "200":
          description: Job
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
      x-mcoda-cli.name: job
      x-mcoda-cli.output-shape: scalar
      x-mcoda-job-type: openapi_change
  /workspaces/{id}/telemetry:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - name: command
        in: query
        schema:
          type: string
      - name: since
        in: query
        schema:
          type: string
    get:
      summary: Telemetry aggregates for a workspace
      operationId: telemetry
      tags: [Telemetry]
      responses:
        "200":
          description: Telemetry view
          content:
            application/json:
              schema:
                type: object
                properties:
                  runs:
                    type: array
                    items:
                      $ref: "#/components/schemas/CommandRun"
                  usage:
                    type: array
                    items:
                      $ref: "#/components/schemas/TokenUsage"
      x-mcoda-cli.name: telemetry
      x-mcoda-cli.output-shape: table
      x-mcoda-docdex-profile: workspace-code
  /workspaces/{id}/tokens:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - name: command
        in: query
        schema:
          type: string
    get:
      summary: Token usage for a workspace
      operationId: tokens
      tags: [Telemetry]
      responses:
        "200":
          description: Token usage
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TokenUsage"
      x-mcoda-cli.name: tokens
      x-mcoda-cli.output-shape: table
      x-mcoda-db-table: token_usage
  /docdex/search:
    parameters:
      - name: q
        in: query
        required: true
        schema:
          type: string
      - name: doc_type
        in: query
        schema:
          type: string
    get:
      summary: Search docdex
      operationId: searchDocdex
      tags: [Docdex]
      responses:
        "200":
          description: Documents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/DocdexDocument"
      x-mcoda-cli.name: docs
      x-mcoda-cli.output-shape: table
      x-mcoda-docdex-profile: sds
  /config:
    get:
      summary: Get workspace config
      operationId: getConfig
      tags: [Config]
      responses:
        "200":
          description: Config
          content:
            application/json:
              schema:
                type: object
                properties:
                  mirrorDocs:
                    type: boolean
                  branch:
                    type: string
                  docdexUrl:
                    type: string
      x-mcoda-cli.name: config
      x-mcoda-cli.output-shape: scalar
  /system/ping:
    get:
      summary: Health check
      operationId: ping
      tags: [System]
      responses:
        "200":
          description: Pong
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  version:
                    type: string
      x-mcoda-cli.name: system
      x-mcoda-cli.output-shape: scalar
components:
  schemas:
    Agent:
      type: object
      properties:
        id:
          type: string
        slug:
          type: string
        adapter:
          type: string
        defaultModel:
          type: string
        capabilities:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, slug, adapter, createdAt, updatedAt]
      x-mcoda-db-table: agents
    AgentAuth:
      type: object
      properties:
        agentId:
          type: string
        configured:
          type: boolean
        lastUpdatedAt:
          type: string
          format: date-time
        lastVerifiedAt:
          type: string
          format: date-time
      required: [agentId, configured]
      x-mcoda-db-table: agent_auth
    AgentPromptManifest:
      type: object
      properties:
        agentId:
          type: string
        jobPrompt:
          type: string
        characterPrompt:
          type: string
        commandPrompts:
          type: object
          additionalProperties:
            type: string
        jobPath:
          type: string
        characterPath:
          type: string
      x-mcoda-db-table: agent_prompts
    RoutingDefaults:
      type: object
      properties:
        workspaceId:
          type: string
        commandName:
          type: string
        agentId:
          type: string
        updatedAt:
          type: string
          format: date-time
      required: [workspaceId, commandName, agentId]
      x-mcoda-db-table: workspace_defaults
    RoutingPreview:
      type: object
      properties:
        workspaceId:
          type: string
        commandName:
          type: string
        resolvedAgent:
          $ref: "#/components/schemas/Agent"
        provenance:
          type: string
        notes:
          type: string
      x-mcoda-cli.output-shape: scalar
    Project:
      type: object
      properties:
        id:
          type: string
        key:
          type: string
        name:
          type: string
      required: [id, key, name]
      x-mcoda-db-table: projects
    Epic:
      type: object
      properties:
        id:
          type: string
        projectId:
          type: string
        key:
          type: string
        title:
          type: string
        description:
          type: string
      required: [id, projectId, key, title]
      x-mcoda-db-table: epics
    UserStory:
      type: object
      properties:
        id:
          type: string
        epicId:
          type: string
        key:
          type: string
        title:
          type: string
        description:
          type: string
      required: [id, epicId, key, title]
      x-mcoda-db-table: user_stories
    Task:
      type: object
      properties:
        id:
          type: string
        projectId:
          type: string
        epicId:
          type: string
        storyId:
          type: string
        title:
          type: string
        status:
          type: string
        priority:
          type: string
        assignee:
          type: string
        description:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        tags:
          type: array
          items:
            type: string
      required: [id, title, status]
      x-mcoda-db-table: tasks
    TaskSummary:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        status:
          type: string
        priority:
          type: string
        epicId:
          type: string
        storyId:
          type: string
      required: [id, title, status]
      x-mcoda-db-table: tasks
    BacklogLaneTotals:
      type: object
      properties:
        tasks:
          type: integer
        story_points:
          type: number
      required: [tasks, story_points]
    BacklogTotals:
      type: object
      properties:
        implementation:
          $ref: "#/components/schemas/BacklogLaneTotals"
        review:
          $ref: "#/components/schemas/BacklogLaneTotals"
        qa:
          $ref: "#/components/schemas/BacklogLaneTotals"
        done:
          $ref: "#/components/schemas/BacklogLaneTotals"
      required: [implementation, review, qa, done]
    BacklogSummary:
      type: object
      properties:
        scope:
          type: object
          properties:
            project:
              type: string
            epic:
              type: string
            story:
              type: string
            assignee:
              type: string
        totals:
          $ref: "#/components/schemas/BacklogTotals"
      required: [scope, totals]
    EffectiveVelocity:
      type: object
      properties:
        implementationSpPerHour:
          type: number
        reviewSpPerHour:
          type: number
        qaSpPerHour:
          type: number
        source:
          type: string
          enum: [config, empirical, mixed]
        windowTasks:
          type: number
          enum: [10, 20, 50]
      required: [implementationSpPerHour, reviewSpPerHour, qaSpPerHour, source]
    EstimateDurations:
      type: object
      properties:
        implementationHours:
          type: number
          nullable: true
        reviewHours:
          type: number
          nullable: true
        qaHours:
          type: number
          nullable: true
        totalHours:
          type: number
          nullable: true
      required: [implementationHours, reviewHours, qaHours, totalHours]
    EstimateEtas:
      type: object
      properties:
        readyToReviewEta:
          type: string
          format: date-time
        readyToQaEta:
          type: string
          format: date-time
        completeEta:
          type: string
          format: date-time
    EstimateResult:
      type: object
      properties:
        scope:
          type: object
          properties:
            workspaceId:
              type: string
            project:
              type: string
            epic:
              type: string
            story:
              type: string
            assignee:
              type: string
        backlogTotals:
          $ref: "#/components/schemas/BacklogTotals"
        effectiveVelocity:
          $ref: "#/components/schemas/EffectiveVelocity"
        durationsHours:
          $ref: "#/components/schemas/EstimateDurations"
        etas:
          $ref: "#/components/schemas/EstimateEtas"
      required: [scope, backlogTotals, effectiveVelocity, durationsHours, etas]
    RefineTasksRequest:
      type: object
      properties:
        projectKey:
          type: string
        epicKey:
          type: string
        userStoryKey:
          type: string
        taskKeys:
          type: array
          items:
            type: string
        statusFilter:
          type: array
          items:
            type: string
        strategy:
          type: string
          enum: [split, merge, enrich, estimate, auto]
          default: auto
        maxTasks:
          type: integer
        dryRun:
          type: boolean
        agentIdOverride:
          type: string
        planInPath:
          type: string
        planOutPath:
          type: string
      required: [projectKey]
    TaskUpdateFields:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        acceptanceCriteria:
          type: array
          items:
            type: string
        type:
          type: string
        storyPoints:
          type: number
          nullable: true
        priority:
          type: number
          nullable: true
        metadata:
          type: object
        status:
          type: string
      additionalProperties: false
    UpdateTaskOp:
      type: object
      properties:
        op:
          type: string
          enum: [update_task]
        taskKey:
          type: string
        updates:
          $ref: "#/components/schemas/TaskUpdateFields"
      required: [op, taskKey, updates]
    SplitChildTask:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        acceptanceCriteria:
          type: array
          items:
            type: string
        type:
          type: string
        storyPoints:
          type: number
          nullable: true
        priority:
          type: number
          nullable: true
        metadata:
          type: object
        dependsOn:
          type: array
          items:
            type: string
      required: [title]
    SplitTaskOp:
      type: object
      properties:
        op:
          type: string
          enum: [split_task]
        taskKey:
          type: string
        keepParent:
          type: boolean
        parentUpdates:
          $ref: "#/components/schemas/TaskUpdateFields"
        children:
          type: array
          items:
            $ref: "#/components/schemas/SplitChildTask"
      required: [op, taskKey, children]
    MergeTasksOp:
      type: object
      properties:
        op:
          type: string
          enum: [merge_tasks]
        targetTaskKey:
          type: string
        sourceTaskKeys:
          type: array
          items:
            type: string
        updates:
          $ref: "#/components/schemas/TaskUpdateFields"
        cancelSources:
          type: boolean
      required: [op, targetTaskKey, sourceTaskKeys]
    UpdateEstimateOp:
      type: object
      properties:
        op:
          type: string
          enum: [update_estimate]
        taskKey:
          type: string
        storyPoints:
          type: number
          nullable: true
        type:
          type: string
        priority:
          type: number
          nullable: true
      required: [op, taskKey]
    RefineOperation:
      oneOf:
        - $ref: "#/components/schemas/UpdateTaskOp"
        - $ref: "#/components/schemas/SplitTaskOp"
        - $ref: "#/components/schemas/MergeTasksOp"
        - $ref: "#/components/schemas/UpdateEstimateOp"
      discriminator:
        propertyName: op
    RefineTasksPlan:
      type: object
      properties:
        strategy:
          type: string
          enum: [split, merge, enrich, estimate, auto]
        operations:
          type: array
          items:
            $ref: "#/components/schemas/RefineOperation"
        warnings:
          type: array
          items:
            type: string
        metadata:
          type: object
          properties:
            generatedAt:
              type: string
            projectKey:
              type: string
            epicKeys:
              type: array
              items:
                type: string
            storyKeys:
              type: array
              items:
                type: string
            jobId:
              type: string
            commandRunId:
              type: string
            strategy:
              type: string
      required: [operations]
    RefineTasksResult:
      type: object
      properties:
        jobId:
          type: string
        commandRunId:
          type: string
        plan:
          $ref: "#/components/schemas/RefineTasksPlan"
        applied:
          type: boolean
        createdTasks:
          type: array
          items:
            type: string
        updatedTasks:
          type: array
          items:
            type: string
        cancelledTasks:
          type: array
          items:
            type: string
        summary:
          type: object
          properties:
            tasksProcessed:
              type: integer
            tasksAffected:
              type: integer
            storyPointsDelta:
              type: number
              nullable: true
      required: [jobId, commandRunId, plan, applied]
    TaskHistoryEntry:
      type: object
      properties:
        id:
          type: string
        taskId:
          type: string
        changeType:
          type: string
        description:
          type: string
        createdAt:
          type: string
          format: date-time
      required: [id, taskId, changeType, createdAt]
      x-mcoda-db-table: task_history
    TaskComment:
      type: object
      properties:
        id:
          type: string
        taskId:
          type: string
        taskRunId:
          type: string
          nullable: true
        jobId:
          type: string
          nullable: true
        sourceCommand:
          type: string
        authorType:
          type: string
          enum: [agent, human]
        authorAgentId:
          type: string
          nullable: true
        category:
          type: string
          nullable: true
        file:
          type: string
          nullable: true
        line:
          type: integer
          nullable: true
        pathHint:
          type: string
          nullable: true
        body:
          type: string
        metadata:
          type: object
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
        resolvedAt:
          type: string
          format: date-time
          nullable: true
        resolvedBy:
          type: string
          nullable: true
      required: [id, taskId, sourceCommand, authorType, body, createdAt]
      x-mcoda-db-table: task_comments
    TaskReview:
      type: object
      properties:
        id:
          type: string
        taskId:
          type: string
        jobId:
          type: string
          nullable: true
        agentId:
          type: string
          nullable: true
        modelName:
          type: string
          nullable: true
        decision:
          type: string
          enum: [approve, changes_requested, block, info_only]
        summary:
          type: string
          nullable: true
        findingsJson:
          type: array
          items:
            type: object
            additionalProperties: true
        testRecommendationsJson:
          type: array
          items:
            type: string
        metadata:
          type: object
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
          nullable: true
      required: [id, taskId, decision, createdAt]
      x-mcoda-db-table: task_reviews
    Job:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        status:
          type: string
        commandRunId:
          type: string
        workspaceId:
          type: string
        projectKey:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        durationSeconds:
          type: number
        metadata:
          type: object
      required: [id, type, status, createdAt, updatedAt]
      x-mcoda-db-table: jobs
    CommandRun:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        workspaceId:
          type: string
        projectKey:
          type: string
        status:
          type: string
        startedAt:
          type: string
          format: date-time
        endedAt:
          type: string
          format: date-time
        durationSeconds:
          type: number
      required: [id, name, workspaceId, status, startedAt]
      x-mcoda-db-table: command_runs
    TaskRun:
      type: object
      properties:
        id:
          type: string
        taskId:
          type: string
        jobId:
          type: string
        status:
          type: string
        startedAt:
          type: string
          format: date-time
        endedAt:
          type: string
          format: date-time
      required: [id, taskId, status]
      x-mcoda-db-table: task_runs
    TaskQaRun:
      type: object
      properties:
        id:
          type: string
        taskId:
          type: string
        jobId:
          type: string
        profile:
          type: string
        status:
          type: string
        startedAt:
          type: string
          format: date-time
        endedAt:
          type: string
          format: date-time
        outcome:
          type: string
      required: [id, taskId, profile, status]
      x-mcoda-db-table: task_qa_runs
    WorkOnTasksRequest:
      type: object
      description: Filters and options for executing work-on-tasks
      properties:
        projectKey:
          type: string
        epicKey:
          type: string
        storyKey:
          type: string
        taskKeys:
          type: array
          items:
            type: string
        statusFilter:
          type: array
          items:
            type: string
        limit:
          type: integer
        parallel:
          type: integer
        noCommit:
          type: boolean
        dryRun:
          type: boolean
        agent:
          type: string
        agentStream:
          type: boolean
    WorkOnTasksResult:
      type: object
      description: Summary of a work-on-tasks run
      properties:
        jobId:
          type: string
        commandRunId:
          type: string
        processed:
          type: integer
        succeeded:
          type: integer
        failed:
          type: integer
        skipped:
          type: integer
        blocked:
          type: array
          items:
            type: string
        warnings:
          type: array
          items:
            type: string
      required: [jobId, commandRunId]
    TokenUsage:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        workspaceId:
          type: string
        commandName:
          type: string
        jobId:
          type: string
        taskId:
          type: string
        action:
          type: string
        promptTokens:
          type: number
        completionTokens:
          type: number
        costUsd:
          type: number
        modelName:
          type: string
        agentId:
          type: string
      required: [timestamp, workspaceId, commandName, action, promptTokens, completionTokens]
      x-mcoda-db-table: token_usage
    TaskLog:
      type: object
      properties:
        taskId:
          type: string
        runId:
          type: string
        entries:
          type: array
          items:
            $ref: "#/components/schemas/LogEntry"
      required: [taskId, runId]
      x-mcoda-db-table: task_logs
    LogEntry:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        level:
          type: string
        message:
          type: string
        metadata:
          type: object
      required: [timestamp, level, message]
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string
      required: [error, message]
    EstimateView:
      type: object
      properties:
        workspaceId:
          type: string
        averageSpPerHour:
          type: number
        sampleSize:
          type: number
        basis:
          type: array
          items:
            $ref: "#/components/schemas/TokenUsage"
    DocdexDocument:
      type: object
      properties:
        id:
          type: string
        docType:
          type: string
        path:
          type: string
        title:
          type: string
        content:
          type: string
        createdAt:
          type: string
        updatedAt:
          type: string
      required: [id, docType, createdAt, updatedAt]
