name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  NPM_CONFIG_PROVENANCE: "true"

jobs:
  package:
    name: Package (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - macos-15
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Install deps
        run: pnpm install

      - name: Build
        run: pnpm -r run build

      - name: Run tests
        run: node tests/all.js

      - name: Pack npm tarballs
        run: node scripts/pack-npm-tarballs.js

      - name: Upload npm packages
        uses: actions/upload-artifact@v4
        with:
          name: npm-pack-${{ matrix.os }}
          path: artifacts/*.tgz

  publish-npm:
    needs: package
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Install deps
        run: pnpm install

      - name: Build
        run: pnpm -r run build

      - name: Packaging guardrails
        run: pnpm --filter mcoda run pack:verify

      - name: Verify tag matches package versions
        env:
          TAG: ${{ github.ref_name }}
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const tag = process.env.TAG.replace(/^v/, '');
            const packages = [
              'packages/cli',
              'packages/core',
              'packages/shared',
              'packages/db',
              'packages/integrations',
              'packages/agents'
            ];
            const mismatches = [];
            for (const dir of packages) {
              const pkgPath = path.join(dir, 'package.json');
              const version = JSON.parse(fs.readFileSync(pkgPath, 'utf8')).version;
              if (version !== tag) {
                mismatches.push(`${dir}: ${version}`);
              }
            }
            if (mismatches.length) {
              console.error(`Tag v${tag} does not match package versions:\n${mismatches.join('\n')}`);
              process.exit(1);
            }
            console.log(`âœ“ Tag matches all package versions: ${tag}`);
          "

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Publish packages (token)
        if: ${{ env.NPM_TOKEN != '' }}
        env:
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: "false"
        run: pnpm -r publish --access public --no-git-checks

      - name: Publish packages (OIDC)
        if: ${{ env.NPM_TOKEN == '' }}
        env:
          NPM_CONFIG_PROVENANCE: "true"
        run: pnpm -r publish --access public --no-git-checks
